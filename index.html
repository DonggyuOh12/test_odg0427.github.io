<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>실시간 손가락 추적 (최적화 버전)</title>
  <!-- MediaPipe Hands 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 20px;
    }
    .video-container {
      width: 100%;
      position: relative;
      display: inline-block;
    }
    /* 해상도를 480x360으로 설정 예시 (더 줄이고 싶다면 320x240 등 사용) */
    video, canvas {
      width: 480px;
      height: 360px;
      border-radius: 5px;
      background-color: #000;
    }
    .status-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>실시간 손가락 추적 (최적화)</h1>
    <div class="video-container">
      <video id="video" autoplay playsinline></video>
      <canvas id="handCanvas" style="position: absolute; top: 0; left: 0;"></canvas>

      <!-- 모델 로딩 표시 영역 -->
      <div id="statusIndicator" class="status-indicator">
        <span id="loadingIndicator" class="loader"></span>
        <span id="statusText">모델 로딩 중...</span>
      </div>
    </div>
  </div>

  <script>
    let video, handCanvas, handCtx;
    let hands, camera;

    document.addEventListener('DOMContentLoaded', async () => {
      video = document.getElementById('video');
      handCanvas = document.getElementById('handCanvas');
      handCtx = handCanvas.getContext('2d');

      try {
        await setupMediapipeHands();
        document.getElementById('statusText').textContent = '모델 로드 완료';
        setTimeout(() => {
          document.getElementById('statusIndicator').style.display = 'none';
        }, 1500);
      } catch (error) {
        console.error("MediaPipe 모델 로드 오류:", error);
        document.getElementById('statusText').textContent = '모델 로드 실패';
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    });

    /********************************************************
     * MediaPipe Hands 초기화 및 카메라 시작
     *  - modelComplexity: 0 => 가장 빠른 모델
     *  - maxNumHands: 1 => 한 손만 추적 => 연산량 감소
     *  - 해상도: 480 x 360
     ********************************************************/
    async function setupMediapipeHands() {
      hands = new window.Hands({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`;
        }
      });

      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 0,  // 0 = 빠름, 1 = 중간, 2 = 정확 but 느림
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      hands.onResults(onHandResults);

      // 해상도를 480x360으로 설정
      camera = new window.Camera(video, {
        onFrame: async () => {
          await hands.send({ image: video });
        },
        width: 480,
        height: 360
      });

      await camera.start();

      // Canvas 크기도 동일하게
      handCanvas.width = 480;
      handCanvas.height = 360;
    }

    /********************************************************
     * 손 인식 결과 처리 (렌더링)
     ********************************************************/
    function onHandResults(results) {
      // 원본 영상 캔버스에 그리기
      handCtx.clearRect(0, 0, handCanvas.width, handCanvas.height);
      handCtx.drawImage(video, 0, 0, handCanvas.width, handCanvas.height);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        for (const landmarks of results.multiHandLandmarks) {
          // (옵션) 연결선: 필요 없으면 주석 처리해 조금 더 빠르게
          window.drawConnectors(handCtx, landmarks, window.HAND_CONNECTIONS, {
            color: '#FFFFFF',
            lineWidth: 2
          });

          // (옵션) 관절 포인트
          window.drawLandmarks(handCtx, landmarks, {
            color: '#FF0000',
            lineWidth: 1,
            radius: 2   // 필요하면 더 작게/크게 조정
          });

          // 검지 손가락 끝 (랜드마크 index: 8) 표시 (조금 크게)
          const indexFingerTip = landmarks[8];
          const x = indexFingerTip.x * handCanvas.width;
          const y = indexFingerTip.y * handCanvas.height;

          handCtx.beginPath();
          handCtx.arc(x, y, 8, 0, 2 * Math.PI);
          handCtx.fillStyle = 'red';
          handCtx.fill();
          handCtx.strokeStyle = 'white';
          handCtx.lineWidth = 2;
          handCtx.stroke();
        }
      }
    }
  </script>
</body>
</html>

