<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0,
                 maximum-scale=1.0,
                 user-scalable=no"/>
  <title>카메라 정보 손꾸락 2 보기</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      overscroll-behavior: none; /* 안드로이드에서 Pull-to-refresh 비활성화 */
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .content-box {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .video-container {
      width: 100%;
      position: relative;   /* 자식 요소를 절대 위치로 배치하기 위해 relative 설정 */
      overflow: hidden;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    video {
      width: 100%;
      background-color: #000;
      border-radius: 8px;
      display: block;
    }

    /* 손 추적용 캔버스 */
    #handsCanvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none; /* 클릭 이벤트가 비디오로 전달되도록 */
      background-color: transparent;
    }
    
    .btn {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-bottom: 10px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .btn:hover {
      background-color: #2980b9;
    }
    
    .btn-danger {
      background-color: #e74c3c;
    }
    
    .btn-danger:hover {
      background-color: #c0392b;
    }
    
    .info-list {
      list-style-type: none;
      padding: 0;
    }
    
    .info-list li {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .info-list li:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-weight: bold;
      color: #3498db;
      display: inline-block;
      width: 180px;
    }
    
    .status-message {
      color: #e74c3c;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .camera-options {
      margin-top: 15px;
    }
    
    select {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: white;
      font-size: 16px;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>카메라 정보 보기</h1>
    
    <div class="content-box">
      <h2>카메라 제어</h2>
      <button id="startBtn" class="btn">카메라 시작</button>
      <button id="switchBtn" class="btn" disabled>카메라 전환</button>
      <button id="stopBtn" class="btn btn-danger" disabled>카메라 중지</button>
      
      <div class="camera-options">
        <label for="cameraSelect">카메라 선택:</label>
        <select id="cameraSelect" disabled>
          <option value="">카메라를 시작하면 선택 가능합니다</option>
        </select>
        
        <label for="resolutionSelect">해상도:</label>
        <select id="resolutionSelect">
          <option value="640x480">640x480</option>
          <option value="1280x720" selected>1280x720 (HD)</option>
          <option value="1920x1080">1920x1080 (FHD)</option>
        </select>
      </div>
      
      <p id="statusMessage" class="status-message"></p>
    </div>
    
    <div class="content-box">
      <h2>카메라 미리보기</h2>
      <div class="video-container" id="videoContainer">
        <video id="video" autoplay playsinline></video>
        <canvas id="handsCanvas"></canvas>
      </div>
    </div>
    
    <div class="content-box">
      <h2>카메라 상세 정보</h2>
      <ul id="cameraInfoList" class="info-list">
        <li><span class="info-label">상태:</span> 카메라가 시작되지 않았습니다</li>
      </ul>
    </div>
  </div>

  <!-- Mediapipe Hands 관련 스크립트 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

  <script>
    // 전역 변수
    let video;
    let mediaStream = null;
    let currentCamera = null;
    let availableCameras = [];

    // 손 추적용 Mediapipe 관련
    let hands = null;
    let handsCanvas = null;
    let handsCtx = null;
    let requestId = 0; // requestAnimationFrame ID

    // DOM 요소
    let startBtn, stopBtn, switchBtn, cameraSelect, resolutionSelect, statusMessage, cameraInfoList;

    // 문서 로드 완료 시 초기화
    document.addEventListener('DOMContentLoaded', () => {
      video = document.getElementById('video');
      startBtn = document.getElementById('startBtn');
      stopBtn = document.getElementById('stopBtn');
      switchBtn = document.getElementById('switchBtn');
      cameraSelect = document.getElementById('cameraSelect');
      resolutionSelect = document.getElementById('resolutionSelect');
      statusMessage = document.getElementById('statusMessage');
      cameraInfoList = document.getElementById('cameraInfoList');
      
      handsCanvas = document.getElementById('handsCanvas');
      handsCtx = handsCanvas.getContext('2d');

      startBtn.addEventListener('click', startCamera);
      stopBtn.addEventListener('click', stopCamera);
      switchBtn.addEventListener('click', switchCamera);
      cameraSelect.addEventListener('change', handleCameraChange);
      resolutionSelect.addEventListener('change', applyResolutionChange);

      window.addEventListener('resize', handleScreenResize);
      window.addEventListener('orientationchange', handleOrientationChange);

      // 카메라 목록 가져오기
      enumerateDevices();

      // Mediapipe Hands 초기화
      initMediapipeHands();
    });

    // ==================== (1) Mediapipe Hands 초기화 ====================
    function initMediapipeHands() {
      hands = new Hands({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }
      });
      hands.setOptions({
        maxNumHands: 2,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      hands.onResults(onResultsHands);
    }

    // (검지: index finger) 랜드마크 인덱스 [5,6,7,8]
    const indexFingerIndices = [5, 6, 7, 8];

    // ==================== (2) Mediapipe 결과 처리 ====================
    function onResultsHands(results) {
      const width = handsCanvas.width;
      const height = handsCanvas.height;

      // 캔버스 초기화
      handsCtx.clearRect(0, 0, width, height);

      // 손을 찾았다면
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        // 여러 손에 대해 반복
        for (let handLandmarks of results.multiHandLandmarks) {
          // "검지" 5,6,7,8번 랜드마크에만 빨간 원 표시
          indexFingerIndices.forEach(idx => {
            const x = handLandmarks[idx].x * width;
            const y = handLandmarks[idx].y * height;

            // 빨간색 원 그리기
            handsCtx.beginPath();
            handsCtx.arc(x, y, 7, 0, 2 * Math.PI);
            handsCtx.fillStyle = 'red';
            handsCtx.fill();
          });
        }
      }
    }

    // ==================== (3) 장치 열거 ====================
    async function enumerateDevices() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        availableCameras = devices.filter(device => device.kind === 'videoinput');
        
        updateCameraSelectOptions();
        
        if (availableCameras.length === 0) {
          statusMessage.textContent = '감지된 카메라가 없습니다.';
          startBtn.disabled = true;
        } else {
          statusMessage.textContent = `${availableCameras.length}개의 카메라가 감지되었습니다. 시작 버튼을 클릭하세요.`;
        }
      } catch (error) {
        console.error('장치 목록 가져오기 오류:', error);
        statusMessage.textContent = '카메라 장치 목록을 가져오는 중 오류가 발생했습니다: ' + error.message;
      }
    }

    function updateCameraSelectOptions() {
      cameraSelect.innerHTML = '';
      
      if (availableCameras.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '사용 가능한 카메라 없음';
        cameraSelect.appendChild(option);
        cameraSelect.disabled = true;
        return;
      }
      
      availableCameras.forEach((camera, index) => {
        const option = document.createElement('option');
        option.value = camera.deviceId;
        option.textContent = camera.label || `카메라 ${index + 1}`;
        cameraSelect.appendChild(option);
      });
      
      cameraSelect.disabled = false;
    }

    // ==================== (4) 카메라 제어 함수 ====================
    async function startCamera() {
      try {
        const [width, height] = resolutionSelect.value.split('x').map(Number);
        const cameraId = cameraSelect.value || (availableCameras.length > 0 ? availableCameras[0].deviceId : null);

        const constraints = {
          video: {
            deviceId: cameraId ? { exact: cameraId } : undefined,
            width: { ideal: width },
            height: { ideal: height }
          },
          audio: false
        };

        if (mediaStream) {
          stopCamera();
        }

        statusMessage.textContent = '카메라 시작 중...';
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = mediaStream;
        currentCamera = cameraId;

        startBtn.disabled = true;
        stopBtn.disabled = false;
        switchBtn.disabled = (availableCameras.length < 2);
        cameraSelect.disabled = false;
        
        // 손캔버스 해상도 지정
        handsCanvas.width = width;
        handsCanvas.height = height;

        await updateCameraInfo();

        if (availableCameras.some(camera => !camera.label)) {
          await enumerateDevices();
        }
        
        statusMessage.textContent = '카메라 시작됨';

        // 실시간 손 추적 시작
        startHandTrackingLoop();
      } catch (error) {
        console.error('카메라 시작 오류:', error);
        statusMessage.textContent = '카메라를 시작하는 중 오류가 발생했습니다: ' + error.message;
      }
    }

    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
        video.srcObject = null;

        startBtn.disabled = false;
        stopBtn.disabled = true;
        switchBtn.disabled = true;
        statusMessage.textContent = '카메라가 중지되었습니다.';
        cameraInfoList.innerHTML = '<li><span class="info-label">상태:</span> 카메라가 시작되지 않았습니다</li>';

        // 손 추적 루프 중지
        cancelAnimationFrame(requestId);
      }
    }

    async function switchCamera() {
      if (availableCameras.length < 2) {
        statusMessage.textContent = '전환할 카메라가 없습니다.';
        return;
      }
      const currentIndex = availableCameras.findIndex(camera => camera.deviceId === currentCamera);
      const nextIndex = (currentIndex + 1) % availableCameras.length;
      cameraSelect.value = availableCameras[nextIndex].deviceId;
      await startCamera();
    }

    // ==================== (5) 카메라 선택/해상도 변경 ====================
    async function handleCameraChange() {
      if (mediaStream) {
        await startCamera();
      }
    }

    async function applyResolutionChange() {
      if (mediaStream) {
        await startCamera();
      }
    }

    // ==================== (6) 실시간 손 추적 루프 ====================
    function startHandTrackingLoop() {
      function onFrame() {
        if (!video.paused && !video.ended) {
          // 현재 영상 프레임을 Mediapipe Hands에 전달
          hands.send({ image: video });
        }
        requestId = requestAnimationFrame(onFrame);
      }
      requestId = requestAnimationFrame(onFrame);
    }

    // ==================== (7) 화면 크기/방향 처리 ====================
    function handleScreenResize() {
      const container = document.getElementById('videoContainer');
      const width = container.clientWidth;
      const height = container.clientHeight;

      // 표시 영역에 맞춰서 canvas CSS 크기 조정
      handsCanvas.style.width = width + 'px';
      handsCanvas.style.height = height + 'px';
    }

    function handleOrientationChange() {
      setTimeout(handleScreenResize, 300);
    }

    // ==================== (8) 카메라 정보 업데이트 ====================
    async function updateCameraInfo() {
      if (!mediaStream) return;
      
      cameraInfoList.innerHTML = '';
      const videoTrack = mediaStream.getVideoTracks()[0];
      
      if (!videoTrack) {
        addInfoItem('상태', '비디오 트랙을 찾을 수 없습니다');
        return;
      }
      
      addInfoItem('상태', '활성');
      addInfoItem('장치 이름', videoTrack.label || '알 수 없음');
      addInfoItem('트랙 ID', videoTrack.id);
      addInfoItem('활성 상태', videoTrack.enabled ? '활성화됨' : '비활성화됨');
      addInfoItem('준비 상태', videoTrack.readyState);
      
      const constraints = videoTrack.getConstraints();
      const settings = videoTrack.getSettings();
      
      if (settings.width && settings.height) {
        addInfoItem('현재 해상도', `${settings.width} × ${settings.height} 픽셀`);
      }
      if (settings.frameRate) {
        addInfoItem('프레임 레이트', `${settings.frameRate.toFixed(1)} fps`);
      }
      if (settings.facingMode) {
        let facingModeText = '알 수 없음';
        switch (settings.facingMode) {
          case 'user': facingModeText = '전면 카메라'; break;
          case 'environment': facingModeText = '후면 카메라'; break;
          case 'left': facingModeText = '왼쪽 카메라'; break;
          case 'right': facingModeText = '오른쪽 카메라'; break;
        }
        addInfoItem('카메라 방향', facingModeText);
      }
      
      if (settings.deviceId) {
        const shortDeviceId = settings.deviceId.substring(0, 8) + '...';
        addInfoItem('장치 ID', shortDeviceId);
      }
      
      if (settings.aspectRatio !== undefined) {
        addInfoItem('종횡비', settings.aspectRatio.toFixed(2));
      }
      if (settings.brightness !== undefined) {
        addInfoItem('밝기', settings.brightness);
      }
      if (settings.colorTemperature !== undefined) {
        addInfoItem('색 온도', settings.colorTemperature + 'K');
      }
      if (settings.contrast !== undefined) {
        addInfoItem('대비', settings.contrast);
      }
      if (settings.saturation !== undefined) {
        addInfoItem('채도', settings.saturation);
      }
      if (settings.sharpness !== undefined) {
        addInfoItem('선명도', settings.sharpness);
      }
      if (settings.zoom !== undefined) {
        addInfoItem('줌', settings.zoom.toFixed(1) + 'x');
      }
      if (settings.focusDistance !== undefined) {
        addInfoItem('초점 거리', settings.focusDistance);
      }
      
      addInfoItem('업데이트 시간', new Date().toLocaleString());
    }
    
    function addInfoItem(label, value) {
      const li = document.createElement('li');
      const labelSpan = document.createElement('span');
      labelSpan.className = 'info-label';
      labelSpan.textContent = label + ':';
      
      li.appendChild(labelSpan);
      li.appendChild(document.createTextNode(' ' + value));
      cameraInfoList.appendChild(li);
    }
  </script>
</body>
</html>
